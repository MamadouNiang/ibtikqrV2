<ejs-toast #element (created)="onCreate($event)" [position]='position' [animation]="animation"></ejs-toast>
<div class="content-wrapper text-sm">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6"><h5 class="m-0 text-dark">Expression de besoin: Planning prévisionnel </h5></div>
        <div class="col-sm-5">
          <div class="btn-toolbar mt-1 mb-md-0 breadcrumb float-sm-right">
            <span class="badge badge-pill even-larger-badge"
                  style="font-size: 1.0em;">Creation d'une nouvelle Campagne Agricole </span>
          </div>
        </div>
        <div class="col-sm-1 ">
          <button type="button" class="btn btn-block btn-primary btn-xs" (click)="onOpenDialog($event)">initier ?
          </button>
        </div>
        <hr>
        <div #container class='root-container'></div>
        <ejs-dialog (beforeOpen)="validation($event)" class="mt-3" id='dialog' isModal='true' [position]='positionModal'
                    #ejDialog header="Ajout d'une Campagne Agricole"
                    showCloseIcon='true'
                    allowDragging='true'
                    [target]='targetElement' width='560px'>
          <ng-template #content>
            <div class="dialogContent">
              <form [formGroup]="validerFormAjout" (ngSubmit)="validationAjout()">
                <div class="table-responsive ">
                  <p class="text-center "><strong> CAMPAGNE AGRICOLE : CA/{{myDateYear}}/{{myDateMonth}}/... </strong>
                  </p>
                  <div class="container text-center">
                    <div class="row g-2 mt-2">
                      <div class="col"><span> Code de la Campagne </span></div>
                      <div class="col-8">
                        <input disabled class="text-center form-control form-control-xs form-control-sm"
                               formControlName="codeCa"
                               type="text" value="CA/{{myDateYear}}/{{myDateMonth}}/">

                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col"><span> Description </span></div>
                      <div class="col-8">
                        <textarea class="form-control form-control-xs form-control-sm"
                                  formControlName="description"></textarea>

                      </div>
                    </div>
                    <div class=" mt-2">
                      <div class="row-12 mt-2"
                           *ngFor="let control of  intrantsFieldAsFormArray.controls ;let i = index;"
                           formArrayName='intrants'>
                        <div class="row" [formGroupName]="i">
                          <div class="col-4">
                            Intrant {{i + 1}}
                          </div>
                          <select (change)="changeIntrant()" class=" col-4 custom-select custom-select-sm" aria-label="Default select example"
                                  formControlName="agriculturalInputId">
                            <option [hidden]="s.selected"  *ngFor="let s of subventions" [ngValue]="s.id">{{s.name}}</option>
                          </select>
                          <div class="col-3">
                            <input class="text-center form-control form-control-xs form-control-sm"
                                   placeholder="quantité"
                                   formControlName="quantity"
                                   type="number">
                          </div>
                          <div class="col-1 mt-1">
                            <button *ngIf="subventions!=undefined  && subventions.length > (i+1)" (click)="intrantsFieldAsFormArray.length === i+1 ? addControl() : remove($event,i)"
                                    [ngClass]="intrantsFieldAsFormArray.length === i+1 ? 'btn-outline-primary fas fa-plus':'btn-outline-danger fas fa-trash' "
                                    class="btn btn-sm "
                                    type="button">
                            </button>
                          </div>
                        </div>

                      </div>


                    </div>


                    <div class="row g-2 mt-2">
                      <div class="col-2 mt-3">
                        <span> Date Debut </span>
                      </div>
                      <div class="col-4 mt-2">
                        <input class="text-center form-control form-control-xs form-control-sm"
                               formControlName="startDate"
                               type="date">
                      </div>
                      <div class="col-2 mt-3"> Date Fin</div>
                      <div class="col-4 mt-2">
                        <input class="text-center form-control form-control-xs form-control-sm"
                               formControlName="endDate"
                               type="date">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-10">
                      </div>
                      <div class="col-2">
                        <button [disabled]="validerFormAjout.invalid "
                                class="btn btn-sm btn-success btn-block"
                                type="submit">Valider
                        </button>
                      </div>
                    </div>
                  </div>
                  <br>
                </div>
              </form>

            </div>
          </ng-template>
        </ejs-dialog>
      </div>
      <hr>
    </div>
    <section class="content">
      <div class="container-fluid">
        <div class="row">

          <div class="col-md-12 text-center">
            <div>
              <button (click)="changeEtatIntrantImCamp()" [disabled]="tailleSelect === 0 " class="btn btn-sm btn-outline-primary"
                      type="button"><span
                class="fas fa-check "></span>
                Valider ({{tailleSelect}})
              </button>
              <button [disabled]="tailleSelect > 0 " (click)="onOpenDialogAjout($event)"
                      class="btn btn-sm btn-outline-primary ml-4"
                      type="button"><span
                class="fas fa-plus "></span>
                Ajouter
              </button>
              <button [disabled]="tailleSelect>1 || tailleSelect === 0 "
                      (click)="onOpenDialogModification($event)"
                      class="btn btn-sm btn-outline-primary ml-4"
                      type="button"><span class="fas fa-pencil-alt "></span>
                Modifier
              </button>
              <button (click)="removeIntrantInCamp()" [disabled]="tailleSelect === 0 "
                      class="btn btn-sm btn-outline-danger ml-4" type="button"><span
                class="fas fa- "></span>
                Supprimer ({{tailleSelect}})
              </button>
            </div>
            <hr class="col-md-5">
          </div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <ejs-grid
              #grid
              [allowSelection]="true"
              [selectionSettings]='selectionOptions'
              (rowSelected)='rowSelected($event)'
              (rowDeselected)="rowDeSelected($event)"
              [dataSource]='allCamp'
              [groupSettings]='groupOptions'
              [allowGrouping]='true'
              id="gridcomp" allowSorting='true'
              height=360
              gridLines="Both"

            >
              <e-columns>
                <e-column type="checkbox" width="33" textAlign='Left'></e-column>
                <e-column field='code' headerText='Campagne' textAlign='Left' width=140>
                  <ng-template #template let-data>
                    {{data.code}}
                  </ng-template>
                </e-column>
                <e-column field='name' headerText='Subventions' textAlign='Center' width=150>
                  <ng-template #template let-data>
                    {{data.name }}
                  </ng-template>
                </e-column>
                <e-column field='quantity' headerText="Quantitée(s)" textAlign='Center' width=120>
                  <ng-template #template let-data>
                    {{data.quantity | json}}
                  </ng-template>
                </e-column>
                <e-column field='unit' headerText="Unité" textAlign='Center' width=80>
                  <ng-template #template let-data>
                    {{data.unit}}
                  </ng-template>
                </e-column>
                <e-column field='unitCost' headerText='Prix (MRU)' textAlign='Center' width=90>
                  <ng-template #template let-data>
                    {{(data.campaignUnitCost ? data.campaignUnitCost : data.unitCost).toLocaleString()}}
                  </ng-template>
                </e-column>
<!--                <e-column field='totalCost' headerText='Total' textAlign='Center' width=90>-->
<!--                  <ng-template #template let-data>-->
<!--                    {{((data.intrantTotal)).toLocaleString()}}-->
<!--                  </ng-template>-->
<!--                </e-column>-->
                <e-column field='intrantTotal' headerText='Total' textAlign='Center' width=90>
                  <ng-template #template let-data>
                    {{((data.intrantTotal)).toLocaleString()}}
                  </ng-template>
                </e-column>
                <e-column field='actived' headerText='Validation' textAlign='Left' width=90>
                  <ng-template #template let-data>
                    <div *ngIf="data.isValid === true;else login"
                         class="statustemp e-activecolor">
                      <span class="statustxt e-activecolor">  Validé</span>
                    </div>
                    <ng-template #login>
                      <div class="statustemp e-inactivecolor">
                        <span class="statustxt e-inactivecolor"> en attente</span>
                      </div>
                    </ng-template>
                  </ng-template>
                </e-column>
                <e-column headerText='Option' textAlign='Center' width=80>
                  <ng-template #template let-data>
                    <a class="btn btn-sm " style="color: #3d3b3b" (click)="onOpenDialogDetail($event,data)"><i
                      class="far fa-eye"> </i></a>

                  </ng-template>
                </e-column>

              </e-columns>
              <e-aggregates>
                <e-aggregate>
                  <e-columns>
                    <e-column field="quantity" type="sum">
                      <ng-template #groupFooterTemplate let-data>{{data.sum.toLocaleString()}} </ng-template>
                    </e-column>
                    <e-column field="unit" type="max">
                      <ng-template #groupFooterTemplate let-data>{{data.max.toLocaleString()}} </ng-template>
                    </e-column>
                    <e-column field='intrantTotal' type="sum">
                      <ng-template #groupFooterTemplate let-data>
                        {{(data.sum).toLocaleString() }}
                      </ng-template>
                    </e-column>
                    <e-column field='intrantTotal' type="sum" >
                      <ng-template #footerTemplate let-data>
                        {{(data.sum).toLocaleString()}}
                      </ng-template>
                    </e-column>
                    <e-column field="unitCost" type="sum">
                      <ng-template #groupFooterTemplate let-data>{{data.sum.toLocaleString()}}  </ng-template>
                    </e-column>
                  </e-columns>
                </e-aggregate>
              </e-aggregates>
            </ejs-grid>
          </div>
        </div>
        <ejs-dialog (beforeOpen)="validation($event)" class="mt-3" id='dialogDetail' isModal='true'
                    [position]='positionModal'
                    allowDragging='true'
                    #ejDialogDetail header="Detail d'une Campagne Agricole : {{this.DetailCodeCa}}"
                    showCloseIcon='true'
                    [target]='targetElementDetail' width='560px'>
          <ng-template #content>
            <div class="dialogContent">
              <form>
                <div class="table-responsive ">
                  <p *ngIf="DetailCa!=undefined || DetailCa!=null" class="text-center "><strong> CAMPAGNE AGRICOLE
                    : {{this.DetailCa.code }} - {{this.DetailCa.name}} </strong>
                  </p>
                  <div class="container text-center">
                    <div class="row g-2 mt-2">
                      <div class="col"><span> Description </span></div>
                      <div class="col-8">
                        <textarea *ngIf="DetailCa!=undefined || DetailCa!=null"
                                  class="form-control form-control-xs form-control-sm">{{this.DetailCa.description}}
                        </textarea>

                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col"><span> Intrant </span></div>
                      <div class="col-8">
                        <input *ngIf="DetailCa!=undefined || DetailCa!=null"
                               class="form-control text-center form-control-xs form-control-sm"
                               value="{{this.DetailCa.name}}">

                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col"><span> Prix </span></div>
                      <div class="col-8">
                        <input *ngIf="DetailCa!=undefined || DetailCa!=null"
                               class="form-control text-center form-control-xs form-control-sm"
                               value="{{this.DetailCa.unitCost}} MRU / {{this.DetailCa.unit}}">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col"><span> Quantitée(s) </span></div>
                      <div class="col-8">
                        <input *ngIf="DetailCa!=undefined || DetailCa!=null"

                               class="form-control text-center form-control-xs form-control-sm"
                               value="{{this.DetailCa.quantity.toLocaleString()}} {{this.DetailCa.unit}}">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col"><span> Total </span></div>
                      <div class="col-8">
                        <input *ngIf="DetailCa!=undefined || DetailCa!=null "
                               class="form-control text-center form-control-xs form-control-sm"
                               value="  {{this.DetailCa.intrantTotal.toLocaleString() }} Mru"
                        >

                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-2 mt-3">
                        <span> Date Debut </span>
                      </div>
                      <div class="col-4 mt-2">
                        <input *ngIf="DetailCa!=undefined || DetailCa!=null"
                               class="text-center form-control form-control-xs form-control-sm"
                               value="{{this.DetailCa.startDate}}"
                               type="date">
                      </div>
                      <div class="col-2 mt-3"> Date Fin</div>
                      <div class="col-4 mt-2">
                        <input *ngIf="DetailCa!=undefined || DetailCa!=null"
                               class="text-center form-control form-control-xs form-control-sm"
                               value="{{this.DetailCa.endDate}}"
                               type="date">
                      </div>
                    </div>
                  </div>
                  <br>
                </div>
              </form>

            </div>
          </ng-template>
        </ejs-dialog>
        <ejs-dialog (beforeOpen)="validation($event)" class="mt-3" id='dialogModification' isModal='true'
                    [position]='positionModal'
                    allowDragging='true'
                    #ejDialogModification header="Modification d'une Campagne Agricole :"
                    showCloseIcon='true'
                    [target]='targetElementModification' width='560px'>
          <ng-template #content>
            <div class="dialogContent">
              <form [formGroup]="validerFormModification" (ngSubmit)="validationModification()">
                <div class="table-responsive ">
                  <br>
                  <p *ngIf="caModifData!=undefined || caModifData!=null" class="text-center "><strong> CAMPAGNE AGRICOLE
                    : {{caModifData.code }} - {{caModifData.name}} </strong>
                  </p>
                  <div class="container text-center">
                    <div class="row g-2 mt-2">
                      <div class="col"><span> Intrant </span></div>
                      <div class="col-8">
                        <input disabled *ngIf="caModifData!=undefined || caModifData!=null"
                               class="form-control text-center form-control-xs form-control-sm"
                               value="{{caModifData.id}}">

                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col"><span> Prix </span></div>
                      <div class="col-8">
                        <input *ngIf="caModifData!=undefined || caModifData!=null"
                               class="form-control text-center form-control-xs form-control-sm"
                               formControlName="unitCost"
                               placeholder="{{caModifData.unitCost}}">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col"><span> Quantitée(s) </span></div>
                      <div class="col-8">
                        <input *ngIf="caModifData!=undefined || caModifData!=null"
                               formControlName="quantity"
                               class="form-control text-center form-control-xs form-control-sm"
                               placeholder="{{caModifData.quantity.toLocaleString()}}">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-10">
                        {{validerFormModification.value}}
                      </div>
                      <div class="col-2">
                        <button [disabled]="validerFormModification.invalid "
                                class="btn btn-sm btn-success btn-block"
                                type="submit">Valider
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </form>

            </div>
          </ng-template>
        </ejs-dialog>
        <ejs-dialog (beforeOpen)="validation($event)" class="mt-3" id='dialogAjout' isModal='true'
                    [position]='positionModal'
                    allowDragging='true'
                    #ejDialogAjout header="Ajout d'un Intrant dans une Campagne Agricole :"
                    showCloseIcon='true'
                    [target]='targetElementAjout' width='560px'>
          <ng-template #content>
            <div class="dialogContent">
              <form [formGroup]="validerFormAjoutIntrant" (ngSubmit)="ajoutIntrantInCampaign()">
                <div class="table-responsive ">
                  <div class="container text-center">
                    <div class="row g-2 mt-2">
                      <div class="col"><span>CAMPAGNES </span></div>
                      <div class="col-8">
                        <ng-select
                                   [clearable]="true"
                                   [searchable]="true"
                                   [closeOnSelect]="true"
                                   [hideSelected]="true"
                                   [multiple]="false"
                                   appearance="outline"
                                   bindLabel="name"
                                   class="custom-class"
                                   placeholder="liste campagnes"
                                   formControlName='id'
                        >
                          <ng-option *ngFor="let campagne of campagneSelect" value="{{campagne.id}}">
                            {{campagne.code}}
                          </ng-option>
                        </ng-select>

                      </div>
                    </div>
                    <div class=" mt-2">
                      <div class="row-12 mt-2"
                           *ngFor="let control of  intrantsFieldAsFormArrayAjout.controls ;let i = index;"
                           formArrayName='intrants'>
                        <div class="row" [formGroupName]="i">
                          <div class="col-4">
                            Intrant {{i + 1}}
                          </div>
                          <select (change)="changeIntrantAjout()" class=" col-4 custom-select custom-select-sm" aria-label="Default select example"
                                  formControlName="agriculturalInputId">
                            <option [hidden]="s.selected" *ngFor="let s of subventions" [ngValue]="s.id">{{s.name}}</option>
                          </select>
                          <div class="col-3">
                            <input class="text-center form-control form-control-xs form-control-sm"
                                   placeholder="quantité"
                                   formControlName="quantity"
                                   type="number">
                          </div>
                          <div class="col-1 mt-1">
                            <button *ngIf="subventions!=undefined  && subventions.length > (i+1)" (click)="intrantsFieldAsFormArrayAjout.length === i+1 ? addControlIntrants() : removeIntrants(i)"
                                    [ngClass]="intrantsFieldAsFormArrayAjout.length === i+1 ? 'btn-outline-primary fas fa-plus':'btn-outline-danger fas fa-trash' "
                                    class="btn btn-sm "
                                    type="button">
                            </button>
                          </div>
                        </div>

                      </div>


                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-10">
                        {{validerFormAjoutIntrant.value | json}}
                      </div>
                      <div class="col-2">
                        <button [disabled]="validerFormAjoutIntrant.invalid "
                                class="btn btn-sm btn-success btn-block"
                                type="submit">Valider
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </form>

            </div>
          </ng-template>
        </ejs-dialog>

      </div>
    </section>

  </div>
</div>
